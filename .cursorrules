# Garmin 3000/5000 ACARS Extension

Plugin ACARS/CPDLC per G3000/G5000 in MSFS 2024.

## Framework Reference (Submodule)
Il codice sorgente del framework MSFS Avionics è disponibile in `reference/msfs-avionics/`.
- Docs online: https://microsoft.github.io/msfs-avionics-mirror/2024/
- GitHub: https://github.com/microsoft/msfs-avionics-mirror

### Percorsi Utili
```
reference/msfs-avionics/src/
├── sdk/                              # @microsoft/msfs-sdk
├── garminsdk/                        # @microsoft/msfs-garminsdk
└── workingtitle-instruments-g3000/   # G3000/G5000 implementation
    ├── html_ui/GTC/                  # GTC components & pages
    │   ├── Pages/MfdHomePage/        # MFD Home page
    │   ├── Pages/UtilitiesPage/      # Utilities page
    │   └── Components/TouchButton/   # Button components
    └── wtg3000common/                # @microsoft/msfs-wtg3000-common
        └── html_ui/Shared/
            └── GtcView/GtcViewKeys.ts  # View keys enum
```

### Aggiornare il Submodule
```bash
git submodule update --remote reference/msfs-avionics
```

## Stack
- Framework: MSFS 2024 Avionics (JS/JSX)
- UI: FSComponent (React-like)
- State: Subject, ArraySubject, ObjectSubject
- Comm: Event Bus
- APIs: Hoppie, SayIntentions, SimBrief

## File Structure
```
src/
├── app.mjs              # Entry point, extends AbstractG3000GtcPlugin
├── AcarsTabView.jsx     # Main UI with tabs (Status, CPDLC)
├── Interceptor.jsx      # Intercepts existing components
├── Hoppie.mjs           # ACARS client (polling, messages)
├── WeightAndBalance.mjs # SimBrief integration
├── AircraftModels.mjs   # Aircraft mappings
└── acars-style.css      # Styles
```

## Conventions
- `.mjs` → JS modules (no JSX)
- `.jsx` → UI components with FSComponent
- Classes: PascalCase
- Functions/vars: camelCase
- Config objects: SCREAMING_SNAKE_CASE

## Core Patterns

### Plugin Entry
```javascript
class MyPlugin extends AbstractG3000GtcPlugin {
  onInstalled() { this.loadCss("coui://..."); }
  registerGtcViews(ctx) { /* register views */ }
}
msfsSdk.registerPlugin(MyPlugin);
```

### Components
Extend `DisplayComponent` or `GtcView`. Use `Subject.create()` for reactive state.
```javascript
this.myState = Subject.create(initialValue);
this.myState.sub((newValue) => { /* react */ });
```

### Event Bus
```javascript
// Publish
bus.getPublisher().pub("event_name", data, true, false);
// Subscribe
bus.getSubscriber().on("event_name").handle(callback);
```

### Views Registration
```javascript
ctx.registerView(GtcViewLifecyclePolicy.Persistent, "KEY", "MFD", 
  (gtcService, controlMode, displayPaneIndex) => <MyView {...} />
);
```

### Dialogs
```javascript
const result = await gtcService.openPopup(GtcViewKeys.TextDialog, "normal", "hide")
  .ref.request({ label: "Field", maxLength: 10 });
if (!result.wasCancelled) { /* use result.payload */ }
```

## CSS Rules
- Support both `.gtc-horizontal` and `.gtc-vertical` orientations
- Use Garmin CSS vars: `--g3000-color-white`, `--gtc-black-background-gradient`, `--gtc-popup-border-radius`
- Prefer absolute positioning with CSS variables
```css
.gtc-horizontal .my-component { font-size: 29px; }
.gtc-vertical .my-component { font-size: 16px; }
```

## MSFS APIs
```javascript
// SimVar
SimVar.GetSimVarValue("TITLE", "string");
SimVar.SetSimVarValue("FUEL TANK LEFT MAIN QUANTITY", "gallons", value);

// Persistent storage
GetStoredData("key"); 
SetStoredData("key", value);

// Input focus (for paste)
Coherent.trigger("FOCUS_INPUT_FIELD", id, "", "", "", false);
Coherent.trigger("UNFOCUS_INPUT_FIELD", id);
```

## Alerts & Audio
```javascript
// CAS Alert
const manager = new CasRegistrationManager(bus);
manager.register({ uuid: "acars-msg", message: "DATALINK MESSAGE" });
bus.getPublisher().pub("cas_activate_alert", { key: { uuid: "acars-msg" }, priority: AnnunciationType.Advisory }, true, false);

// Audio
const audio = new AuralAlertRegistrationManager(bus);
audio.register({ uuid: "acars-msg-sound", queue: "acars-queue", sequence: "tone_caution" });
bus.getPublisher().pub("aural_alert_trigger", "acars-msg-sound", true, false);
```

## Dual GTC Sync
- Primary GTC creates client, secondary syncs via Event Bus
- Use `window.acarsSide` ("primary" | "secondary")
- Sync events: `acars_message`, `acars_state_request`, `acars_status_param`

## Lifecycle
Always implement for resource management:
- `onResume()` - resume subscriptions
- `onPause()` - pause subscriptions  
- `destroy()` - cleanup intervals/timeouts, destroy refs with `.getOrDefault()?.destroy()`

## Supported Aircraft
| Aircraft | ICAO | Notes |
|----------|------|-------|
| Citation Longitude | C700 | |
| Vision Jet | SF50 | |
| TBM 930 | TBM9 | |
| Citation CJ3+ | C25B | Liv2Air mod supported |

## ACARS Services
```javascript
const SERVICES = {
  hoppie: "https://www.hoppie.nl/acars/system/connect.html",
  sayintentions: "https://acars.sayintentions.ai/acars/system/connect.html",
};
```

## Hoppie ACARS API
Docs: https://www.hoppie.nl/acars/system/tech.html

### Connessione
- **URL**: `http://www.hoppie.nl/acars/system/connect.html`
- **Protocollo**: GET o POST (preferire POST per payload lunghi)
- **Timeout HTTP**: 15 secondi, poi skip e retry dopo delay normale

### Parametri Richiesta
| Param | Descrizione |
|-------|-------------|
| `logon` | Codice segreto (min 24 char, mix lowercase/uppercase/numeri) |
| `from` | Callsign mittente |
| `to` | Callsign destinatario (o "SERVER" per messaggi al server) |
| `type` | Tipo messaggio: `poll`, `telex`, `cpdlc`, `ping`, `posreq`, `position`, `datareq`, `peek`, `progress`, `inforeq` |
| `packet` | Payload del messaggio |

### Tipi di Messaggio
| Type | Uso |
|------|-----|
| `poll` | **Polling periodico** - ritorna messaggi pendenti per il callsign |
| `telex` | Messaggi generici (bulk del traffico non specializzato) |
| `cpdlc` | Messaggi CPDLC/ADS-C per ATC. "@" = line feed |
| `ping` | Test connessione (non registra online). Con `packet=ALL-CALLSIGNS` ritorna lista stazioni |
| `peek` | Come poll ma ritorna TUTTI i messaggi delle ultime 24h (usare con cautela!) |
| `inforeq` | Richiesta info: `metar ICAO`, `taf ICAO`, `vatatis ICAO`, `peatis ICAO`, `ivaoatis ICAO` |
| `posreq` | Richiesta posizione |
| `progress` | Out/off/on/in times e ETA |

### Polling Best Practices
```
⚠️ REGOLE FONDAMENTALI:
1. NON iniziare polling finché non si invia il PRIMO messaggio
2. Polling ogni 45-75 secondi (random per stabilità server)
3. Dopo invio richiesta: polling ogni 20 sec per breve tempo
4. Timeout 15 sec → skip attempt, retry dopo delay normale
5. URL max 256 caratteri (usare POST per payload lunghi)
```

### Esempio Richiesta
```javascript
// GET
`${url}?logon=${logon}&from=${callsign}&to=SERVER&type=poll&packet=`

// Telex
`${url}?logon=${logon}&from=${callsign}&to=${dest}&type=telex&packet=${encodeURIComponent(msg)}`

// CPDLC
`${url}?logon=${logon}&from=${callsign}&to=${atcStation}&type=cpdlc&packet=${cpdlcPayload}`

// Weather request
`${url}?logon=${logon}&from=${callsign}&to=SERVER&type=inforeq&packet=metar LIRF`
```

### Workaround Telex per InfoReq
Se non implementato inforeq, usare telex con pattern HCnnn:
```
HC000 text  → Echo test
HC001 ICAO  → PilotEdge ATIS
HC002 ICAO  → IVAO ATIS (trattini → underscore)
```

### Response Parsing
- Messaggi multipli separati da delimitatori
- CPDLC: "@" indica line feed
- Poll ritorna lista messaggi pendenti o vuoto

## Key Imports
- `@microsoft/msfs-sdk`: DisplayComponent, FSComponent, Subject, ArraySubject, CasRegistrationManager
- `@microsoft/msfs-garminsdk`: TouchButton, UnitsUserSettings
- `@microsoft/msfs-wtg3000-gtc`: AbstractG3000GtcPlugin, GtcView, GtcViewLifecyclePolicy, GtcViewKeys
- `@microsoft/msfs-wtg3000-common`: WeightFuelUserSettings
